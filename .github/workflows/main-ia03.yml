name: Build + Aqua SaaS Scanner (Register in Console)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  id-token: write   # if needed for future OIDC

jobs:
  build-and-scan:
    name: Build Docker Image + Aqua SaaS Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Aqua Registry
        run: |
          docker login registry.aquasec.com \
            -u "${{ secrets.AQUA_REGISTRY_USERNAME }}" \
            -p "${{ secrets.AQUA_REGISTRY_PASSWORD }}"
     
      - name: Build Docker Image
        run: |
          docker build -t prg-image:${{ github.sha }} -f Dockerfile .

      - name: Scan Image with Aqua SaaS Scanner (Token Auth)
        env:
          SCANNER_TOKEN: ${{ secrets.AQUA_SCANNER_TOKEN }}
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            registry.aquasec.com/scanner:latest-saas \
            scan \
              -H https://console.cloud.aquasec.com \
              -A "${SCANNER_TOKEN}" \
              -D --direct-cc \
              --local \
              --registry "Docker Hub" \
              --register \
              prg-image:${{ github.sha }}

      - name: Log in to Docker Hub
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Tag & Push Image to Docker Hub
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          docker tag prg-image:${{ github.sha }} ${{ secrets.DOCKERHUB_USERNAME }}/prg-image:${{ github.sha }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/prg-image:${{ github.sha }}

      - name: Manifest Generation SBOM
        run: |
          docker image ls
          export BILLY_SERVER=https://billy.codesec.aquasec.com

          curl -sLo install.sh https://download.codesec.aquasec.com/billy/install.sh
          curl -sLo install.sh.checksum https://github.com/argonsecurity/releases/releases/latest/download/install.sh.checksum

          if ! sha256sum --check install.sh.checksum; then
            echo "install.sh checksum failed"
            exit 1
          fi
          BINDIR="." sh install.sh
          rm install.sh install.sh.checksum
          ./billy generate \
            --access-token "${{ secrets.GITHUB_TOKEN }}" \
            --aqua-key "${{ secrets.AQUA_KEY }}" \
            --aqua-secret "${{ secrets.AQUA_SECRET }}" \
            --artifact-path "stalibali/prg-image:${{ github.sha }}" \
         
            # The docker image name:tag of the newly built image
            # --artifact-path "my-image-name:${{ env.tag-version }}" 
            # OR the path to the root folder of your project. I.e my-repo/my-app 
            # --artifact-path "${{env.MY_APP_ROOT}}"
