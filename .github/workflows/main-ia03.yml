name: Build + Aqua SaaS Scanner (Register in Console)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  id-token: write

jobs:
  build-and-scan:
    name: Build Docker Image + Aqua SaaS Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Aqua Registry
        run: |
          docker login registry.aquasec.com \
            -u "${{ secrets.AQUA_REGISTRY_USERNAME }}" \
            -p "${{ secrets.AQUA_REGISTRY_PASSWORD }}"

      - name: Build Docker Image
        run: |
          docker build -t prg-image:${{ github.sha }} -f Dockerfile .

      # Image scan (Aqua SaaS scanner container) â€” includes ENV/config secrets via TRIVY_IMAGE_CONFIG_SCANNERS
      - name: Scan Image with Aqua SaaS Scanner (Token Auth)
        env:
          SCANNER_TOKEN: ${{ secrets.AQUA_SCANNER_TOKEN }}
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -e TRIVY_SCANNERS="vuln,secret" \
            -e TRIVY_IMAGE_CONFIG_SCANNERS="secret" \
            registry.aquasec.com/scanner:latest-saas \
            scan \
              -H https://console.cloud.aquasec.com \
              -A "${SCANNER_TOKEN}" \
              -D --direct-cc \
              --local \
              --registry "Docker Hub" \
              --register \
              prg-image:${{ github.sha }}

      - name: Log in to Docker Hub
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login \
            -u "${{ secrets.DOCKERHUB_USERNAME }}" \
            --password-stdin

      # Optional: repo/filesystem scan (this scans the repo contents, not the built image)
      - name: Run Aqua scanner (fs scan)
        uses: docker://aquasec/aqua-scanner
        env:
          AQUA_KEY: ${{ secrets.AQUA_KEY }}
          AQUA_SECRET: ${{ secrets.AQUA_SECRET }}
          GITHUB_TOKEN: ${{ github.token }}
          TRIVY_RUN_AS_PLUGIN: "aqua"
        with:
          args: >
            trivy fs
            --scanners misconfig,vuln,secret
            --sast
            --severity HIGH,CRITICAL
            .

      - name: Tag & Push Image to Docker Hub
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          docker tag prg-image:${{ github.sha }} ${{ secrets.DOCKERHUB_USERNAME }}/prg-image:${{ github.sha }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/prg-image:${{ github.sha }}

      - name: Manifest Generation SBOM
        env:
          BILLY_SERVER: https://billy.codesec.aquasec_
