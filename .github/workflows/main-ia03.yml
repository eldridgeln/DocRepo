name: Build + Aqua SaaS Scanner (Register in Console)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  id-token: write   # if needed for future OIDC

jobs:
  build-and-scan:
    name: Build Docker Image + Aqua SaaS Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Aqua Registry
        run: |
          docker login registry.aquasec.com \
            -u "${{ secrets.AQUA_REGISTRY_USERNAME }}" \
            -p "${{ secrets.AQUA_REGISTRY_PASSWORD }}"
     
      - name: Build Docker Image
        run: |
          docker build -t prg-image:${{ github.sha }} -f Dockerfile .

      - name: Scan Image with Aqua SaaS Scanner (Token Auth)
        env:
          SCANNER_TOKEN: ${{ secrets.AQUA_SCANNER_TOKEN }}
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            registry.aquasec.com/scanner:2022.4 \
            scan \
              -H https://console.cloud.aquasec.com \
              -A "${SCANNER_TOKEN}" \
              -D --direct-cc \
              --local \
              --registry "Docker Hub" \
              --register \
              #exit-code: 1 \
              # --severity HIGH,CRITICAL \
              #  --json /scan-results.json \
              prg-image:${{ github.sha }}

      - name: Upload Scan Results Artifact (JSON)
        if: always()   # upload even on failure
        uses: actions/upload-artifact@v4
        with:
          name: aqua-scan-results
          path: /scan-results.json   # adjust path if changed above

      - name: Log in to Docker Hub
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Tag & Push Image to Docker Hub
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          docker tag prg-image:${{ github.sha }} ${{ secrets.DOCKERHUB_USERNAME }}/prg-image:${{ github.sha }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/prg-image:${{ github.sha }}

      # Optional: Generate SBOM from filesystem (repo/code level)
      - name: Generate SBOM with Trivy OSS
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          format: cyclonedx
          output: sbom.cdx.json
          severity: UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL

      - name: Upload SBOM Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.cdx.json
